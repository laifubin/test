name: Backups Review

on:
    workflow_dispatch:
        # æ‰‹åŠ¨è§¦å‘ - åˆ—å‡ºæœåŠ¡å™¨å¤‡ä»½æ–‡ä»¶

env:
    DEPLOY_PATH: '/var/www/html'
    APP_NAME: 'frontend-app'

jobs:
    backups_review:
        runs-on: ubuntu-latest

        steps:
            - name: åˆ—å‡ºå¤‡ä»½æ–‡ä»¶
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USERNAME }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  script: |
                      echo "=== å¯ç”¨å¤‡ä»½æ–‡ä»¶åˆ—è¡¨ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰==="
                      cd ${{ env.DEPLOY_PATH }}

                      if ls ${{ env.APP_NAME }}_*.backup.tar.gz 1> /dev/null 2>&1; then
                        echo "ğŸ“¦ å¤‡ä»½æ–‡ä»¶åˆ—è¡¨ï¼ˆæœ€æ–°åœ¨å‰ï¼‰:"
                        echo "=========================================="
                        # æŒ‰ä¿®æ”¹æ—¶é—´å€’åºæ’åˆ—
                        ls -lat ${{ env.APP_NAME }}_*.backup.tar.gz
                        
                        echo ""
                        echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:"
                        echo "æ€»å¤‡ä»½æ•°: $(ls ${{ env.APP_NAME }}_*.backup.tar.gz | wc -l)"
                        echo "æœ€æ–°å¤‡ä»½: $(ls -t ${{ env.APP_NAME }}_*.backup.tar.gz | head -1)"
                        echo "æœ€æ—©å¤‡ä»½: $(ls -t ${{ env.APP_NAME }}_*.backup.tar.gz | tail -1)"
                        
                        echo ""
                        echo "ğŸ’¾ ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
                        echo "=========================================="
                        du -sh ${{ env.APP_NAME }}_*.backup.tar.gz | sort -hr
                        echo "æ€»å¤§å°: $(du -ch ${{ env.APP_NAME }}_*.backup.tar.gz | grep total)"
                        
                      else
                        echo "âŒ æœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶"
                      fi

                      echo ""
                      echo "ğŸ“ ä½¿ç”¨è¯´æ˜:"
                      echo "=========================================="
                      echo "æ‰‹åŠ¨å›æ»šå‘½ä»¤:"
                      echo "tar -xzf ${{ env.APP_NAME }}_20250101_120000_abc1234.backup.tar.gz -C ${{ env.APP_NAME }}/dist --strip-components 1"
                      echo ""
                      echo "åˆ é™¤æ—§å¤‡ä»½å‘½ä»¤:"
                      echo "find . -name \"${{ env.APP_NAME }}_*.backup.tar.gz\" -mtime +7 -delete"

            - name: ç”Ÿæˆå¤‡ä»½æŠ¥å‘Š
              if: always()
              run: |
                  echo "å¤‡ä»½åˆ—è¡¨æŸ¥è¯¢å®Œæˆ"
                  echo "æŸ¥çœ‹ä¸Šæ–¹ SSH è¾“å‡ºè·å–è¯¦ç»†ä¿¡æ¯"
